{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<div class="space-y-6 page-animate-in">
    
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white dark:bg-slate-900 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-800 shadow-sm">
        <div>
            <h2 class="text-2xl font-black text-slate-800 dark:text-white tracking-tighter uppercase italic">
                Performance <span class="text-blue-600">Comercial</span>
            </h2>
            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-[0.2em]">
                {% if mes_actual %} Análisis: {{ meses[mes_actual|int - 1][1] }} 2024 {% else %} Consolidado Anual 2024 {% endif %}
            </p>
        </div>
        
        <div class="flex flex-wrap items-center gap-2">
            <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl items-center border border-transparent dark:border-slate-700">
                <select id="mesSelector" class="bg-transparent border-none rounded-lg text-[10px] font-black uppercase py-1.5 px-3 outline-none text-slate-800 dark:text-white cursor-pointer focus:ring-0">
                    <option value="" class="dark:bg-slate-800 text-slate-800 dark:text-white">Todo el Año</option>
                    {% for valor, nombre in meses %}
                    <option value="{{ valor }}" {% if mes_actual == valor %}selected{% endif %} class="dark:bg-slate-800 text-slate-800 dark:text-white">
                        {{ nombre }}
                    </option>
                    {% endfor %}
                </select>
                <button onclick="location.href='?mes='+document.getElementById('mesSelector').value" 
                        class="bg-white dark:bg-slate-700 text-slate-800 dark:text-white text-[9px] font-black px-4 py-1.5 rounded-lg shadow-sm hover:bg-blue-500 hover:text-white transition-all">
                    FILTRAR
                </button>
            </div>
            
            <button onclick="descargarExcel()" 
                    class="bg-emerald-500 hover:bg-emerald-600 text-white text-[9px] font-black px-4 py-2.5 rounded-xl flex items-center gap-2 shadow-md transition-all active:scale-95">
                <i class="bi bi-file-earmark-spreadsheet-fill"></i> EXPORTAR
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="group bg-white dark:bg-slate-900 p-5 rounded-[1.5rem] border border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-all">
            <div class="flex justify-between items-start mb-3">
                <div class="p-2 bg-blue-50 dark:bg-blue-900/30 rounded-xl text-blue-600">
                    <i class="bi bi-graph-up-arrow text-lg"></i>
                </div>
                <span class="text-[9px] font-black text-blue-500 bg-blue-50 dark:bg-blue-900/20 px-2 py-0.5 rounded-full italic">INGRESOS</span>
            </div>
            <h3 class="text-xl font-black text-slate-800 dark:text-white">${{ "{:,.0f}".format(stats.ingresos) }}</h3>
            <p class="text-[9px] text-slate-400 font-bold mt-1">Facturación bruta</p>
        </div>

        <div class="group bg-white dark:bg-slate-900 p-5 rounded-[1.5rem] border border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-all">
            <div class="flex justify-between items-start mb-3">
                <div class="p-2 bg-rose-50 dark:bg-rose-900/30 rounded-xl text-rose-600">
                    <i class="bi bi-cart-dash text-lg"></i>
                </div>
                <span class="text-[9px] font-black text-rose-500 bg-rose-50 dark:bg-rose-900/20 px-2 py-0.5 rounded-full italic">GASTOS</span>
            </div>
            <h3 class="text-xl font-black text-slate-800 dark:text-white">${{ "{:,.0f}".format(stats.gastos) }}</h3>
            <p class="text-[9px] text-slate-400 font-bold mt-1">Costos operativos</p>
        </div>

        <div class="group bg-white dark:bg-slate-900 p-5 rounded-[1.5rem] border border-slate-100 dark:border-slate-800 shadow-sm hover:shadow-md transition-all">
            <div class="flex justify-between items-start mb-3">
                <div class="p-2 bg-emerald-50 dark:bg-emerald-900/30 rounded-xl text-emerald-600">
                    <i class="bi bi-cash-stack text-lg"></i>
                </div>
                <span class="text-[9px] font-black text-emerald-500 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-0.5 rounded-full italic">UTILIDAD</span>
            </div>
            <h3 class="text-xl font-black text-slate-800 dark:text-white">${{ "{:,.0f}".format(stats.utilidad) }}</h3>
            <p class="text-[9px] text-slate-400 font-bold mt-1">Ganancia neta</p>
        </div>

        <div class="bg-slate-900 p-5 rounded-[1.5rem] text-white shadow-lg relative overflow-hidden border border-slate-700">
            <p class="text-[9px] font-black text-blue-400 uppercase tracking-widest mb-0.5">Rentabilidad</p>
            <h3 class="text-2xl font-black italic">{{ "{:.1f}".format(stats.margen) }}%</h3>
            <div class="mt-3 h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                <div class="h-full bg-gradient-to-r from-blue-600 to-blue-400 rounded-full rentabilidad-bar"></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div class="lg:col-span-5 bg-white dark:bg-slate-900 p-6 rounded-[2rem] border border-slate-100 dark:border-slate-800 shadow-sm">
            <h4 class="text-xs font-black text-slate-700 dark:text-white uppercase italic border-l-3 border-blue-500 pl-3 mb-6">Estado de Cartera</h4>
            <div class="h-[280px] relative">
                <canvas id="cobranzaChart"></canvas>
            </div>
        </div>
        <div class="lg:col-span-7 bg-white dark:bg-slate-900 p-6 rounded-[2rem] border border-slate-100 dark:border-slate-800 shadow-sm">
            <h4 class="text-xs font-black text-slate-700 dark:text-white uppercase italic border-l-3 border-emerald-500 pl-3 mb-6">Rendimiento por Cliente</h4>
            <div class="h-[280px]">
                <canvas id="clientesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.font.size = 10;

    const dataCobros = JSON.parse('{{ chart_cobranza | safe }}');
    const colorMap = { 'Pagada': '#10b981', 'Pendiente': '#f59e0b', 'Vencida': '#ef4444' };

    new Chart(document.getElementById('cobranzaChart'), {
        type: 'doughnut',
        data: {
            labels: dataCobros.labels,
            datasets: [{
                data: dataCobros.values,
                backgroundColor: dataCobros.labels.map(l => colorMap[l] || '#64748b'),
                hoverOffset: 20,
                borderWidth: 0,
                cutout: '78%',
                borderRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: '#64748b', usePointStyle: true, pointStyle: 'circle', padding: 25, font: { size: 11, weight: 'bold' } }
                },
                datalabels: {
                    color: '#fff',
                    backgroundColor: (ctx) => ctx.dataset.backgroundColor[ctx.dataIndex],
                    borderRadius: 6,
                    font: { weight: 'black', size: 10 },
                    padding: 6,
                    anchor: 'center',
                    align: 'center',
                    offset: 5,
                    formatter: (value, ctx) => {
                        let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                        return sum > 0 ? ((value * 100) / sum).toFixed(0) + "%" : "0%";
                    }
                }
            }
        }
    });

    const dataCli = JSON.parse('{{ chart_top_clientes | safe }}');
    const ctxCli = document.getElementById('clientesChart').getContext('2d');
    const blueGradient = ctxCli.createLinearGradient(0, 0, 0, 400);
    blueGradient.addColorStop(0, '#3b82f6');
    blueGradient.addColorStop(1, '#1e40af');

    new Chart(ctxCli, {
        type: 'bar',
        data: {
            labels: dataCli.labels,
            datasets: [{
                data: dataCli.values,
                backgroundColor: blueGradient,
                borderRadius: 20,
                barThickness: 50
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { display: false },
                x: { ticks: { font: { weight: 'black', size: 10 }, color: '#64748b' }, grid: { display: false } }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: 'center', align: 'top', offset: 10, color: '#ffffff',
                    font: { weight: 'black', size: 11 },
                    formatter: (value) => '$' + (value/1000000).toFixed(1) + 'M'
                }
            }
        }
    });
    document.querySelector('.rentabilidad-bar').style.width = '{{ stats.margen }}%';
    
    function descargarExcel() {
        const mes = document.getElementById('mesSelector').value;
        window.location.href = `/exportar_comercial${mes ? '?mes='+mes : ''}`;
    }
</script>
{% endblock %}
