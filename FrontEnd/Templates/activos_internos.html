{% extends "base.html" %} {% block content %}

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<div id="toast-container" class="fixed top-5 right-5 z-[100] space-y-3">
  {% with messages = get_flashed_messages(with_categories=true) %} {% if
  messages %} {% for category, message in messages %}
  <div
    class="toast-item flex items-center p-4 min-w-[300px] bg-white dark:bg-slate-900 shadow-2xl rounded-2xl border-l-4 {% if category == 'success' %}border-green-500{% else %}border-red-500{% endif %} animate-in slide-in-from-right duration-500"
  >
    <div class="flex-1">
      <p
        class="text-[10px] uppercase font-black text-slate-400 tracking-widest"
      >
        Notificación
      </p>
      <p class="text-xs font-bold text-slate-700 dark:text-white">
        {{ message }}
      </p>
    </div>
    <button class="text-slate-400 hover:text-slate-600">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  {% endfor %} {% endif %} {% endwith %}
</div>

<div class="space-y-6">
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h2
        class="text-2xl font-black text-slate-800 dark:text-white tracking-tight italic uppercase"
      >
        <i class="bi bi-box-seam mr-2 text-blue-600"></i>Activos Internos
      </h2>
      <p
        class="text-[11px] text-slate-500 font-bold uppercase tracking-widest opacity-70"
      >
        Gestión y Depuración de Recursos Logísticos
      </p>
    </div>

    <div
      class="bg-slate-200 dark:bg-slate-800 p-1.5 rounded-2xl flex items-center shadow-inner"
    >
      <a
        href="?tipo=personal"
        class="px-8 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-tighter transition-all {% if tipo == 'personal' %}bg-white dark:bg-blue-600 shadow-lg text-blue-600 dark:text-white{% else %}text-slate-500 hover:text-slate-700{% endif %}"
      >
        <i class="bi bi-people-fill mr-2"></i> Personal
      </a>
      <a
        href="?tipo=vehiculos"
        class="px-8 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-tighter transition-all {% if tipo == 'vehiculos' %}bg-white dark:bg-blue-600 shadow-lg text-blue-600 dark:text-white{% else %}text-slate-500 hover:text-slate-700{% endif %}"
      >
        <i class="bi bi-truck mr-2"></i> Flota
      </a>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div
      class="lg:col-span-1 bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm"
    >
      <h3
        class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4 text-center"
      >
        Cargos De Personal
      </h3>
      <div class="relative h-64">
        <canvas id="chartDistribucion"></canvas>
      </div>
    </div>

    <div
      class="lg:col-span-2 bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] border border-slate-200 dark:border-slate-800 shadow-sm"
    >
      <h3
        class="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4"
      >
        Distribucion De Flotas (Marcas)
      </h3>
      <div class="relative h-64">
        <canvas id="chartActividad"></canvas>
      </div>
    </div>
  </div>

  <div
    class="bg-white dark:bg-slate-900 p-4 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm"
  >
    <div class="relative w-full group">
      <i
        class="bi bi-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors"
      ></i>
      <input
        type="text"
        id="searchInput"
        placeholder="BUSCAR POR NOMBRE, PLACA O ID..."
        class="w-full pl-12 pr-4 py-3 bg-slate-50 dark:bg-slate-800/50 border-none rounded-2xl text-[11px] font-black uppercase tracking-widest focus:ring-2 focus:ring-blue-500 outline-none dark:text-white transition-all shadow-inner"
      />
    </div>
  </div>

  <div
    class="bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden"
  >
    <div class="overflow-x-auto">
      <table class="w-full text-left text-[11px] table-fixed min-w-[800px]">
        <thead>
          <tr
            class="bg-slate-50/50 dark:bg-slate-800/60 border-b border-slate-200 dark:border-slate-800"
          >
            {% for col in columnas %}
            <th
              class="px-8 py-5 font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest"
            >
              {{ col }}
            </th>
            {% endfor %}
            <th
              class="px-8 py-5 text-right font-black text-slate-500 uppercase w-28"
            >
              Acción
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
          {% if datos %} {% for fila in datos %}
          <tr
            class="data-row hover:bg-blue-50/50 dark:hover:bg-blue-900/10 transition-colors group"
          >
            {% for celda in fila[1:] %}
            <td
              class="px-8 py-5 text-slate-700 dark:text-slate-300 truncate font-bold italic group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors"
            >
              {{ celda if celda is not none else '---' }}
            </td>
            {% endfor %}
            <td class="px-8 py-5 text-right">
              <button
                type="button"
                onclick="openDeleteModal('{{ fila[0] }}')"
                class="w-8 h-8 rounded-lg bg-red-50 dark:bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center ml-auto"
              >
                <i class="bi bi-trash3-fill"></i>
              </button>
            </td>
          </tr>
          {% endfor %} {% else %}
          <tr>
            <td
              colspan="{{ columnas|length + 1 }}"
              class="px-8 py-16 text-center text-slate-400 font-black uppercase tracking-widest opacity-50 italic"
            >
              <i class="bi bi-inbox text-4xl block mb-2"></i>
              Sin registros activos en {{ tipo }}
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if total_pages > 1 %}
    <div
      class="p-4 border-t border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/30 flex items-center justify-between"
    >
      <p class="text-[10px] text-slate-500 font-bold">
        Mostrando {{ (page-1)*10 + 1 }} - {% if page*10 < total_records %}{{
        page*10 }}{% else %}{{ total_records }}{% endif %} de {{ total_records
        }} registros
      </p>
      <div class="flex items-center gap-1">
        {% if page > 1 %}
        <a
          href="?tipo={{ tipo }}&page={{ page-1 }}"
          class="px-3 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-[10px] font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors"
        >
          <i class="bi bi-chevron-left"></i>
        </a>
        {% endif %} {% set start_page = page-2 if page-2 > 1 else 1 %} {% set
        end_page = page+3 if page+3 <= total_pages+1 else total_pages+1 %} {%
        for p in range(start_page, end_page) %}
        <a
          href="?tipo={{ tipo }}&page={{ p }}"
          class="px-3 py-1 {% if p == page %}bg-blue-600 text-white{% else %}bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600{% endif %} rounded-lg text-[10px] font-bold transition-colors"
        >
          {{ p }}
        </a>
        {% endfor %} {% if page < total_pages %}
        <a
          href="?tipo={{ tipo }}&page={{ page+1 }}"
          class="px-3 py-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-[10px] font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-600 transition-colors"
        >
          <i class="bi bi-chevron-right"></i>
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
  const isDark = document.documentElement.classList.contains("dark");
  const colorTexto = isDark ? "#94a3b8" : "#64748b";
  const colorGrid = isDark ? "rgba(255,255,255,0.05)" : "rgba(0,0,0,0.05)";

  Chart.register(ChartDataLabels);
  Chart.defaults.color = colorTexto;
  Chart.defaults.font.family = "'Poppins', sans-serif";
  Chart.defaults.font.weight = "700";
  Chart.defaults.font.size = 10;

  const dataEmp = {{ chart_emp | tojson }};
  const ctxEmp = document.getElementById("chartDistribucion").getContext("2d");
  new Chart(ctxEmp, {
    type: "doughnut",
    data: {
      labels: dataEmp.labels,
      datasets: [{
        data: dataEmp.values,
        backgroundColor: ["#2563eb", "#6366f1", "#f87171", "#10b981", "#f59e0b", "#64748b"],
        borderWidth: 0,
        hoverOffset: 20,
      }],
    },
    plugins: [ChartDataLabels],
    options: {
      maintainAspectRatio: false,
      cutout: "70%",
      plugins: {
        legend: { position: "bottom", labels: { usePointStyle: true, padding: 20 } },
        datalabels: {
          color: "#fff",
          font: { weight: "900", size: 12 },
          formatter: (value) => value,
        },
      },
    },
  });

  // 2. Gráfico DINÁMICO de Vehículos (Marcas)
  const dataVeh = {{ chart_veh | tojson }};
  const ctxVeh = document.getElementById("chartActividad").getContext("2d");
  new Chart(ctxVeh, {
    type: "pie", // Cambiado a Pie para variar el diseño
    data: {
      labels: dataVeh.labels,
      datasets: [{
        data: dataVeh.values,
        backgroundColor: ["#3b82f6", "#8b5cf6", "#ec4899", "#f43f5e", "#f97316", "#06b6d4"],
        borderWidth: 0,
      }],
    },
    plugins: [ChartDataLabels],
    options: {
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "bottom", labels: { usePointStyle: true, padding: 20 } },
        datalabels: {
          color: "#fff",
          font: { weight: "900", size: 12 },
          formatter: (value) => value,
        },
      },
    },
  });

  let deleteTargetUrl = "";

  function openDeleteModal(id) {
    const modal = document.getElementById("deleteModal");
    const modalContent = document.getElementById("modalContent");
    deleteTargetUrl = `/eliminar_activo/{{ tipo }}/${id}`;
    modal.classList.remove("hidden");
    modal.classList.add("flex");

    setTimeout(() => {
      modalContent.classList.remove("scale-95");
      modalContent.classList.add("scale-100");
    }, 10);
  }

  function closeDeleteModal() {
    const modal = document.getElementById("deleteModal");
    const modalContent = document.getElementById("modalContent");

    modalContent.classList.replace("scale-100", "scale-95");

    document.body.style.overflow = "auto";

    setTimeout(() => {
      modal.classList.replace("flex", "hidden");
      resetDeleteButton();
    }, 200);
  }

  function processDelete() {
    const btnText = document.getElementById("btnText");
    const btnSpinner = document.getElementById("btnSpinner");
    const confirmBtn = document.getElementById("confirmBtn");

    if (btnText) btnText.innerText = "BORRANDO...";
    if (btnSpinner) btnSpinner.classList.remove("hidden");
    if (confirmBtn)
      confirmBtn.classList.add("opacity-50", "pointer-events-none");

    setTimeout(() => {
      window.location.href = deleteTargetUrl;
    }, 800);
  }

  function resetDeleteButton() {
    const btnText = document.getElementById("btnText");
    const btnSpinner = document.getElementById("btnSpinner");
    const confirmBtn = document.getElementById("confirmBtn");

    if (btnText) btnText.innerText = "ELIMINAR";
    if (btnSpinner) btnSpinner.classList.add("hidden");
    if (confirmBtn)
      confirmBtn.classList.remove("opacity-50", "pointer-events-none");
  }

  document
    .getElementById("searchInput")
    ?.addEventListener("input", function () {
      const val = this.value.toLowerCase();
      document.querySelectorAll(".data-row").forEach((row) => {
        row.style.display = row.innerText.toLowerCase().includes(val)
          ? ""
          : "none";
      });
    });

  setTimeout(() => {
    document.querySelectorAll(".toast-item").forEach((el) => {
      el.classList.add("opacity-0", "translate-x-full");
      setTimeout(() => el.remove(), 600);
    });
  }, 4000);
</script>

{% include 'components/delete_modal.html' %} {% endblock %}
